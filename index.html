<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventory</title>

<style>
:root{
  --bg:#f1f5f9;
  --panel:#ffffff;
  --border:#e5e7eb;
  --text:#0f172a;
  --muted:#64748b;
  --ps:#2563eb;
  --xbox:#16a34a;
  --nintendo:#dc2626;
  --ipad:#111827;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Inter,system-ui;
  background:
    radial-gradient(1200px 400px at top center,#e0e7ff 0%,transparent 60%),
    var(--bg);
  background-repeat:no-repeat;
  background-attachment:fixed;
  color:var(--text);
  padding:36px 20px;
}

.wrapper{max-width:1150px;margin:auto}

/* ---------- TILES ---------- */

.tiles{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:18px;
  margin-bottom:28px;
}

.tile{
  background:var(--panel);
  border-radius:18px;
  padding:20px;
  display:flex;
  gap:16px;
  cursor:pointer;
  box-shadow:0 12px 28px rgba(0,0,0,.08);
  border-left:6px solid transparent;
  transition:.2s;
}
.tile:hover{transform:translateY(-2px)}
.tile.active{outline:2px solid #c7d2fe}

.tile.ps{border-left-color:var(--ps)}
.tile.xbox{border-left-color:var(--xbox)}
.tile.nintendo{border-left-color:var(--nintendo)}
.tile.ipad{border-left-color:var(--ipad)}

.tile-logo{
  width:52px;height:52px;border-radius:14px;
  background:#f8fafc;display:flex;
  align-items:center;justify-content:center;
}
.tile-logo img{max-width:36px;max-height:36px}

/* ---------- PANEL ---------- */

.panel{
  background:var(--panel);
  border-radius:22px;
  overflow:hidden;
  box-shadow:0 30px 60px rgba(0,0,0,.12);
}

.header{
  padding:20px 30px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid var(--border);
}

table{width:100%;border-collapse:collapse}
th,td{padding:16px 30px;border-bottom:1px solid var(--border)}
th{background:#f8fafc;font-size:12px;color:var(--muted)}

.stock-ok{color:#16a34a;font-weight:600}
.stock-low{color:#f59e0b;font-weight:600}
.stock-critical{color:#dc2626;font-weight:700}

.action-btn{
  background:#2563eb;color:#fff;border:none;
  border-radius:8px;padding:6px 14px;cursor:pointer
}
.stock-input{
  width:90px;padding:6px;border-radius:8px;border:1px solid var(--border)
}
</style>
</head>

<body>
<div class="wrapper">

  <div id="brandTiles" class="tiles"></div>

  <div class="panel">
    <div class="header">
      <h2 id="tableTitle">Select a brand</h2>
      <button onclick="unlockEditing()">ðŸ”’ Unlock Editing</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Part</th>
          <th>Stock</th>
          <th>Status</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL="https://thvbweemnzdvwyaxvwbz.supabase.co";
const SUPABASE_KEY="sb_publishable_U6Nsj6HClebAVWOx7MLhng_3t2z6w1G";
const EDIT_PASSWORD="BeckyStock";

const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let allData=[];
let activeBrand=null;
let editingUnlocked=false;

const brands=["PlayStation","Xbox","Nintendo","iPad"];

/* ðŸ”´ðŸŸ¡ðŸŸ¢ PER-PRODUCT THRESHOLDS (FINAL, CORRECT VERSION) */
function stockClass(item){
  const low =
    Number.isInteger(item.low_threshold) && item.low_threshold > 0
      ? item.low_threshold
      : 20;

  const critical =
    Number.isInteger(item.critical_threshold) && item.critical_threshold > 0
      ? item.critical_threshold
      : 10;

  if(item.stock <= critical) return "stock-critical";
  if(item.stock <= low) return "stock-low";
  return "stock-ok";
}

function renderTiles(){
  const c=document.getElementById("brandTiles");
  c.innerHTML="";
  brands.forEach(b=>{
    const t=document.createElement("div");
    t.className="tile";
    t.innerHTML=`<strong>${b}</strong>`;
    t.onclick=()=>{activeBrand=b;renderTable()};
    c.appendChild(t);
  });
}

function renderTable(){
  if(!activeBrand)return;
  document.getElementById("tableTitle").innerText=`${activeBrand} Parts`;
  const body=document.getElementById("tableBody");
  body.innerHTML="";

  allData.filter(p=>p.brand===activeBrand).forEach(p=>{
    console.log("DEBUG:",p.name,p.stock,p.low_threshold,p.critical_threshold);

    body.innerHTML+=`
      <tr>
        <td>${p.name}</td>
        <td class="${stockClass(p)}">${p.stock}</td>
        <td>
          ${p.stock <= (p.critical_threshold ?? 10) ? "Critical" :
            p.stock <= (p.low_threshold ?? 20) ? "Low" : "OK"}
        </td>
        <td>
          <button class="action-btn" onclick="startEdit(this,${p.id},${p.stock})">Edit</button>
        </td>
      </tr>
    `;
  });
}

function unlockEditing(){
  if(prompt("Password")===EDIT_PASSWORD){
    editingUnlocked=true;
    alert("Editing unlocked");
  }
}

function startEdit(btn,id,stock){
  if(!editingUnlocked)return;
  const row=btn.closest("tr");
  row.children[1].innerHTML=`<input class="stock-input" value="${stock}">`;
  btn.outerHTML=`<button class="action-btn" onclick="saveEdit(this,${id})">Save</button>`;
}

async function saveEdit(btn,id){
  const row=btn.closest("tr");
  const val=parseInt(row.querySelector("input").value);

  await client.from("products").update({stock:val}).eq("id",id);

  const item=allData.find(p=>p.id===id);
  if(item)item.stock=val;

  renderTable();
}

async function loadStock(){
  const {data,error}=await client.from("products").select("*");
  if(error){console.error(error);return}
  allData=data;
  renderTiles();
}

loadStock();
</script>
</body>
</html>
