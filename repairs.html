<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Repairs</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#f1f5f9;
  --panel:#ffffff;
  --border:#e5e7eb;
  --text:#0f172a;
  --muted:#64748b;
  --green:#16a34a;
  --amber:#f59e0b;
  --red:#dc2626;
  --blue:#2563eb;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Inter,system-ui;
  background:var(--bg);
  padding:36px 20px;
  color:var(--text);
}

.wrapper{max-width:1200px;margin:auto;}

.card{
  background:var(--panel);
  border-radius:22px;
  padding:28px;
  box-shadow:0 30px 60px rgba(0,0,0,.12);
}

/* HEADER */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
  flex-wrap:wrap;
  gap:12px;
}

.controls{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}

select,input,textarea{
  padding:8px 10px;
  border-radius:8px;
  border:1px solid var(--border);
}

textarea{
  min-height:160px;
  resize:vertical;
}

button{
  background:var(--blue);
  color:#fff;
  border:none;
  border-radius:10px;
  padding:8px 14px;
  cursor:pointer;
}

button.secondary{
  background:#e5e7eb;
  color:#0f172a;
}

button.danger{
  background:var(--red);
}

/* TABLE */
table{width:100%;border-collapse:collapse;}

th,td{
  padding:14px;
  border-bottom:1px solid var(--border);
  text-align:center;
}

th{
  font-size:12px;
  color:var(--muted);
  background:#f8fafc;
}

.days.green{color:var(--green);font-weight:600}
.days.amber{color:var(--amber);font-weight:600}
.days.red{color:var(--red);font-weight:700}

/* MODALS */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10;
}

.modal-content{
  background:#fff;
  border-radius:20px;
  padding:24px;
  width:520px;
  max-width:90%;
  display:flex;
  flex-direction:column;
  gap:12px;
}

.modal-content input,
.modal-content select,
.modal-content textarea{
  width:100%;
}

/* COMPLETE MODAL TABS */
.tabs{
  display:flex;
  gap:6px;
  margin-bottom:12px;
}

.tab-btn{
  padding:8px 16px;
  border-radius:10px;
  border:none;
  cursor:pointer;
  font-weight:600;
}

.tab-btn:not(.active){
  background:#dbeafe;
  color:#1e40af;
}

.tab-btn.active{
  background:#2563eb;
  color:#fff;
}

.tab-content{
  display:none;
  max-height:260px;
  overflow-y:auto;
  margin-bottom:12px;
}

/* PARTS BOXES */
.part-row{
  display:grid;
  grid-template-columns:1fr auto 70px;
  align-items:center;
  gap:12px;
  padding:10px 12px;
  border:1px solid var(--border);
  border-radius:10px;
  margin-bottom:8px;
  background:#f8fafc;
}

.part-name{font-weight:500}

.stock-label{font-weight:600}

.stock-count{
  font-weight:800;
  color:var(--green);
}

.part-row input{
  width:70px;
  text-align:center;
}
</style>
</head>

<body>

<!-- üîê PASSWORD GATE -->
<script>
const APP_PASSWORD = "ShopAccess123";
if (!sessionStorage.getItem("auth")) {
  const pass = prompt("Enter password");
  if (pass !== APP_PASSWORD) {
    alert("Access denied");
    location.href = "https://google.com";
  } else {
    sessionStorage.setItem("auth", "yes");
  }
}
</script>

<div class="wrapper">
<div class="card">

<div class="header">
  <h1>üõ† Repairs <span id="openCounter" style="color:var(--red)">0 open</span></h1>
  <div class="controls">
    <input id="customerSearch" placeholder="Search customer‚Ä¶">
    <select id="deviceFilter">
      <option value="">All Devices</option>
      <option>PlayStation</option>
      <option>Xbox</option>
      <option>Nintendo</option>
      <option>iPad</option>
      <option>Laptop</option>
    </select>
    <label><input type="checkbox" id="showCompleted"> Show completed</label>
    <button onclick="openAddModal()">+ Add Repair</button>
  </div>
</div>

<button class="secondary" onclick="location.href='index.html'">‚Üê Back</button>

<table>
<thead>
<tr>
  <th>Customer</th>
  <th>Device</th>
  <th>Checked In</th>
  <th>Days Open</th>
  <th>Actions</th>
</tr>
</thead>
<tbody id="repairsBody"></tbody>
</table>

</div>
</div>

<!-- ADD / EDIT MODAL -->
<div class="modal" id="addModal">
<div class="modal-content">
<h2 id="modalTitle">Add Repair</h2>

<input id="custName" placeholder="Customer name">
<select id="deviceType">
  <option>PlayStation</option>
  <option>Xbox</option>
  <option>Nintendo</option>
  <option>iPad</option>
  <option>Laptop</option>
</select>
<input type="date" id="checkedIn">
<textarea id="notes" placeholder="Notes"></textarea>

<div style="display:flex;gap:10px;justify-content:flex-end;">
  <button onclick="saveRepair()">Save</button>
  <button class="secondary" onclick="closeAddModal()">Cancel</button>
</div>
</div>
</div>

<!-- DETAILS MODAL -->
<div class="modal" id="detailsModal">
<div class="modal-content" id="detailsContent"></div>
</div>

<!-- COMPLETE MODAL -->
<div class="modal" id="completeModal">
<div class="modal-content" id="completeContent"></div>
</div>

<script>
const SUPABASE_URL="https://thvbweemnzdvwyaxvwbz.supabase.co";
const SUPABASE_KEY="sb_publishable_U6Nsj6HClebAVWOx7MLhng_3t2z6w1G";
const client=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

let repairs=[],editingId=null,completingId=null;

const daysOpen=d=>Math.floor((Date.now()-new Date(d))/86400000);
const daysClass=d=>d<=2?"green":d<=5?"amber":"red";

async function loadRepairs(){
  const {data}=await client.from("repairs").select("*").order("checked_in");
  repairs=data||[];
  render();
}

function render(){
  repairsBody.innerHTML="";
  const f=deviceFilter.value;
  const s=showCompleted.checked;
  const q=customerSearch.value.toLowerCase();

  repairs.forEach(r=>{
    if(f && r.device!==f) return;
    if(!s && r.completed) return;
    if(q && !r.customer.toLowerCase().includes(q)) return;

    const d=daysOpen(r.checked_in);
    repairsBody.innerHTML+=`
<tr>
<td>${r.customer}</td>
<td>${r.device}</td>
<td>${r.checked_in}</td>
<td class="days ${daysClass(d)}">${d}</td>
<td>
  <button onclick="viewDetails(${r.id})">Details</button>
  ${r.completed?'':`<button onclick="completeRepair(${r.id})">Complete</button>`}
  <button onclick="editRepair(${r.id})">Edit</button>
  <button class="danger" onclick="deleteRepair(${r.id})">Delete</button>
</td>
</tr>`;
  });

  openCounter.innerText=`${repairs.filter(r=>!r.completed).length} open`;
}

function openAddModal(){
  editingId=null;
  modalTitle.innerText="Add Repair";
  custName.value="";
  notes.value="";
  checkedIn.value=new Date().toISOString().slice(0,10);
  addModal.style.display="flex";
}

function closeAddModal(){addModal.style.display="none";}

async function saveRepair(){
  const payload={
    customer:custName.value,
    device:deviceType.value,
    checked_in:checkedIn.value,
    notes:notes.value,
    completed:false
  };
  editingId
    ? await client.from("repairs").update(payload).eq("id",editingId)
    : await client.from("repairs").insert(payload);

  closeAddModal();
  loadRepairs();
}

function editRepair(id){
  const r=repairs.find(x=>x.id===id);
  editingId=id;
  modalTitle.innerText="Edit Repair";
  custName.value=r.customer;
  deviceType.value=r.device;
  checkedIn.value=r.checked_in;
  notes.value=r.notes;
  addModal.style.display="flex";
}

function viewDetails(id){
  const r=repairs.find(x=>x.id===id);
  detailsContent.innerHTML=`
<h2>${r.customer}</h2>
<p><strong>Device:</strong> ${r.device}</p>
<p><strong>Checked in:</strong> ${r.checked_in}</p>
<p><strong>Notes:</strong><br>${r.notes||"‚Äî"}</p>
<button onclick="detailsModal.style.display='none'">Close</button>`;
  detailsModal.style.display="flex";
}

async function deleteRepair(id){
  if(!confirm("Delete this repair?")) return;
  await client.from("repairs").delete().eq("id",id);
  loadRepairs();
}

async function completeRepair(id){
  completingId=id;
  const r=repairs.find(x=>x.id===id);
  const {data:products}=await client.from("products").select("*");

  let html=`<h2>Complete: ${r.customer}</h2><div class="tabs">`;
  ["PlayStation","Xbox","Nintendo","iPad","Laptop"].forEach((c,i)=>{
    html+=`<button class="tab-btn ${i?'':'active'}" data-tab="${c}">${c}</button>`;
  });
  html+=`</div>`;

  ["PlayStation","Xbox","Nintendo","iPad","Laptop"].forEach((c,i)=>{
    html+=`<div class="tab-content" data-tab="${c}" style="display:${i?'none':'block'}">`;
    products.filter(p=>p.brand===c).forEach(p=>{
      html+=`
        <div class="part-row">
          <span class="part-name">${p.name}</span>
          <span class="stock-label">
            Stock <span class="stock-count">${p.stock}</span>
          </span>
          <input type="number" min="0" max="${p.stock}" data-id="${p.id}">
        </div>
      `;
    });
    html+=`</div>`;
  });

  html+=`
    <button onclick="confirmComplete()">Confirm</button>
    <button class="secondary" onclick="completeModal.style.display='none'">Cancel</button>
  `;

  completeContent.innerHTML=html;
  completeModal.style.display="flex";

  document.querySelectorAll(".tab-btn").forEach(b=>{
    b.onclick=()=>{
      document.querySelectorAll(".tab-btn").forEach(x=>x.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(x=>x.style.display="none");
      b.classList.add("active");
      document.querySelector(\`.tab-content[data-tab="\${b.dataset.tab}"]\`).style.display="block";
    }
  });
}

async function confirmComplete(){
  await client.from("repairs").update({completed:true}).eq("id",completingId);
  completeModal.style.display="none";
  loadRepairs();
}

deviceFilter.onchange=render;
showCompleted.onchange=render;
customerSearch.oninput=render;

loadRepairs();
</script>
</body>
</html>
