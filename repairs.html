<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Repairs</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:Inter,system-ui;
  background:#f1f5f9;
  padding:30px;
}

.wrapper{
  max-width:1200px;
  margin:auto;
}

.top-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}

button{
  padding:8px 14px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  background:#2563eb;
  color:#fff;
  font-weight:600;
}

button.secondary{
  background:#e5e7eb;
  color:#0f172a;
}

button.danger{
  background:#dc2626;
}

table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  border-radius:14px;
  overflow:hidden;
  box-shadow:0 12px 30px rgba(0,0,0,.08);
}

th,td{
  padding:16px;
  border-bottom:1px solid #e5e7eb;
  text-align:center;
}

th{
  background:#f8fafc;
  font-size:13px;
  color:#64748b;
}

.actions{
  display:flex;
  gap:8px;
  justify-content:center;
}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
}

.modal-content{
  background:#fff;
  padding:22px;
  width:420px;
  border-radius:14px;
}

.modal-content h2{
  margin-top:0;
}

.modal-content label{
  display:block;
  margin-top:12px;
  font-size:13px;
  font-weight:600;
}

.modal-content input,
.modal-content textarea{
  width:100%;
  padding:8px;
  border-radius:8px;
  border:1px solid #cbd5f5;
  margin-top:4px;
}

.modal-actions{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-top:18px;
}
</style>
</head>

<body>
<div class="wrapper">

  <div class="top-bar">
    <h2>Open Repairs</h2>
    <div>
      <button onclick="openModal()">Add Repair</button>
      <button class="secondary" onclick="location.href='index.html'">Back to Inventory</button>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Customer</th>
        <th>Item</th>
        <th>Days Open</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="repairsBody"></tbody>
  </table>

</div>

<!-- MODAL -->
<div class="modal" id="repairModal">
  <div class="modal-content">
    <h2 id="modalTitle">Add Repair</h2>
    <input type="hidden" id="repairId">

    <label>Customer</label>
    <input id="username">

    <label>Item</label>
    <input id="item">

    <label>Notes</label>
    <textarea id="notes"></textarea>

    <div class="modal-actions">
      <button class="secondary" onclick="closeModal()">Cancel</button>
      <button onclick="saveRepair()">Save</button>
    </div>
  </div>
</div>

<script>
const client = supabase.createClient(
  "YOUR_SUPABASE_URL",
  "YOUR_SUPABASE_ANON_KEY"
);

async function loadRepairs(){
  const { data, error } = await client
    .from("repairs")
    .select("*")
    .eq("completed", false)
    .order("checked_in", { ascending:true });

  if(error){
    console.error(error);
    return;
  }

  const body = document.getElementById("repairsBody");
  body.innerHTML = "";

  data.forEach(r => {
    const days = Math.floor((Date.now() - new Date(r.checked_in)) / 86400000);

    body.innerHTML += `
      <tr>
        <td>${r.username}</td>
        <td>${r.item}</td>
        <td>${days}</td>
        <td class="actions">
          <button onclick="editRepair(${r.id})">Edit</button>
          <button onclick="completeRepair(${r.id})">Complete</button>
          <button class="danger" onclick="deleteRepair(${r.id})">Delete</button>
        </td>
      </tr>
    `;
  });
}

function openModal(){
  document.getElementById("repairId").value = "";
  document.getElementById("username").value = "";
  document.getElementById("item").value = "";
  document.getElementById("notes").value = "";
  document.getElementById("modalTitle").innerText = "Add Repair";
  document.getElementById("repairModal").style.display = "flex";
}

function closeModal(){
  document.getElementById("repairModal").style.display = "none";
}

async function saveRepair(){
  const id = document.getElementById("repairId").value;
  const payload = {
    username: username.value,
    item: item.value,
    notes: notes.value
  };

  let error;
  if(id){
    ({ error } = await client.from("repairs").update(payload).eq("id", id));
  } else {
    ({ error } = await client.from("repairs").insert(payload));
  }

  if(error){
    alert("Save failed");
    console.error(error);
    return;
  }

  closeModal();
  loadRepairs();
}

async function editRepair(id){
  const { data } = await client.from("repairs").select("*").eq("id", id).single();

  repairId.value = data.id;
  username.value = data.username;
  item.value = data.item;
  notes.value = data.notes;

  modalTitle.innerText = "Edit Repair";
  repairModal.style.display = "flex";
}

async function completeRepair(id){
  if(!confirm("Mark this repair complete?")) return;

  await client.from("repairs")
    .update({ completed:true })
    .eq("id", id);

  loadRepairs();
}

async function deleteRepair(id){
  if(!confirm("Delete this repair permanently?")) return;

  const { error } = await client.from("repairs").delete().eq("id", id);

  if(error){
    alert("Delete failed");
    console.error(error);
    return;
  }

  loadRepairs();
}

loadRepairs();
</script>
</body>
</html>
