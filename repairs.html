<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Repairs</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#f1f5f9;
  --panel:#ffffff;
  --border:#e5e7eb;
  --text:#0f172a;
  --muted:#64748b;
  --green:#16a34a;
  --amber:#f59e0b;
  --blue:#2563eb;
  --red:#dc2626;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui;
  background:var(--bg);
  padding:36px 20px;
  color:var(--text);
}
.wrapper{max-width:1200px;margin:auto;}
.card{
  background:var(--panel);
  border-radius:22px;
  padding:28px;
  box-shadow:0 30px 60px rgba(0,0,0,.12);
}

/* HEADER */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}
.controls{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
select,input,textarea{
  padding:6px 10px;
  border-radius:8px;
  border:1px solid var(--border);
}
textarea{min-height:160px;resize:vertical;}
button{
  background:var(--blue);
  color:#fff;
  border:none;
  border-radius:10px;
  padding:8px 14px;
  cursor:pointer;
}
button.secondary{background:#e5e7eb;color:#0f172a;}
button.danger{background:var(--red);}

/* TABLE */
table{width:100%;border-collapse:collapse;}
th,td{padding:14px;border-bottom:1px solid var(--border);text-align:center;}
th{font-size:12px;color:var(--muted);background:#f8fafc;}

/* STATUS BADGES */
.status-badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:12px;
  font-weight:600;
  font-size:12px;
  color:#fff;
}
.status-Checked-in{background:var(--blue);}
.status-Awaiting\ parts{background:var(--amber);}
.status-Completed{background:var(--green);}
</style>
</head>
<body>

<!-- üîê PASSWORD GATE -->
<script>
const APP_PASSWORD = "ShopAccess123";
if(!sessionStorage.getItem("auth")){
  const pass = prompt("Enter password");
  if(pass !== APP_PASSWORD){ alert("Access denied"); location.href="https://google.com"; }
  else sessionStorage.setItem("auth","yes");
}
</script>

<div class="wrapper">
  <div class="card">
    <div class="header">
      <h1>üõ† Repairs <span id="openCounter" style="color:var(--red)">0 open</span></h1>
      <div class="controls">
        <input id="customerSearch" placeholder="Search customer‚Ä¶">
        <select id="deviceFilter">
          <option value="">All Devices</option>
          <option>PlayStation</option>
          <option>Xbox</option>
          <option>Nintendo</option>
          <option>iPad</option>
          <option>Laptop</option>
        </select>
        <label><input type="checkbox" id="showCompleted"> Show completed</label>
        <button onclick="openAddModal()">+ Add Repair</button>
      </div>
    </div>

    <button class="secondary" onclick="location.href='index.html'">‚Üê Back</button>

    <table>
      <thead>
        <tr>
          <th>Customer</th>
          <th>Device</th>
          <th>Checked In</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="repairsBody"></tbody>
    </table>
  </div>
</div>

<!-- ADD / EDIT MODAL -->
<div class="modal" id="addModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);align-items:center;justify-content:center;z-index:10;">
  <div style="background:#fff;border-radius:20px;padding:24px;width:520px;max-width:90%;display:flex;flex-direction:column;gap:12px;">
    <h2 id="modalTitle">Add Repair</h2>
    <input id="custName" placeholder="Customer name">
    <select id="deviceType">
      <option>PlayStation</option>
      <option>Xbox</option>
      <option>Nintendo</option>
      <option>iPad</option>
      <option>Laptop</option>
    </select>
    <input type="date" id="checkedIn">
    <textarea id="notes" placeholder="Notes"></textarea>
    <button onclick="saveRepair()">Save</button>
    <button class="secondary" onclick="closeAddModal()">Cancel</button>
  </div>
</div>

<script>
const SUPABASE_URL="https://thvbweemnzdvwyaxvwbz.supabase.co";
const SUPABASE_KEY="sb_publishable_U6Nsj6HClebAVWOx7MLhng_3t2z6w1G";
const client=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

let repairs=[],editingId=null;
const stages=["Checked-in","Awaiting parts","Completed"];

function daysOpen(d){return Math.floor((Date.now()-new Date(d))/86400000);}
function daysClass(d){return d<=2?"green":d<=5?"amber":"red";}

async function loadRepairs(){
  const {data}=await client.from("repairs").select("*").order("checked_in");
  repairs=data||[];
  render();
}

function render(){
  const f=deviceFilter.value;
  const s=showCompleted.checked;
  const q=customerSearch.value.toLowerCase();
  repairsBody.innerHTML="";
  repairs.forEach(r=>{
    if(f && r.device!==f) return;
    if(!s && r.status==="Completed") return;
    if(q && !r.customer.toLowerCase().includes(q)) return;

    repairsBody.innerHTML+=`
<tr>
  <td>${r.customer}</td>
  <td>${r.device}</td>
  <td>${r.checked_in}</td>
  <td><span class="status-badge status-${r.status.replace(' ','\\ ')}">${r.status}</span></td>
  <td>
    ${r.status!=="Completed"?`<button onclick="advanceStatus(${r.id})">‚Üí Next Stage</button>`:""}
    <button onclick="editRepair(${r.id})">Edit</button>
    <button class="danger" onclick="deleteRepair(${r.id})">Delete</button>
  </td>
</tr>`;
  });

  openCounter.innerText=`${repairs.filter(r=>r.status!=="Completed").length} open`;
}

function openAddModal(){
  editingId=null;
  modalTitle.innerText="Add Repair";
  custName.value="";
  notes.value="";
  checkedIn.value=new Date().toISOString().slice(0,10);
  addModal.style.display="flex";
}

function closeAddModal(){addModal.style.display="none";}

async function saveRepair(){
  const payload={
    customer:custName.value,
    device:deviceType.value,
    checked_in:checkedIn.value,
    notes:notes.value,
    status:"Checked-in"
  };
  if(editingId){
    await client.from("repairs").update(payload).eq("id",editingId);
  } else{
    await client.from("repairs").insert(payload);
  }
  closeAddModal();
  loadRepairs();
}

function editRepair(id){
  const r=repairs.find(x=>x.id===id);
  editingId=id;
  modalTitle.innerText="Edit Repair";
  custName.value=r.customer;
  deviceType.value=r.device;
  checkedIn.value=r.checked_in;
  notes.value=r.notes;
  addModal.style.display="flex";
}

async function deleteRepair(id){
  if(!confirm("Delete this repair?")) return;
  await client.from("repairs").delete().eq("id",id);
  loadRepairs();
}

async function advanceStatus(id){
  const r=repairs.find(x=>x.id===id);
  if(!r) return;
  const currentIndex=stages.indexOf(r.status);
  const nextStatus=stages[Math.min(currentIndex+1, stages.length-1)];
  const { error } = await client.from("repairs").update({ status: nextStatus }).eq("id",id);
  if(error){ console.error(error); return; }
  r.status=nextStatus;
  render();
}

deviceFilter.onchange=render;
showCompleted.onchange=render;
customerSearch.oninput=render;

loadRepairs();
</script>
</body>
</html>
