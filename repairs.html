<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Repairs</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#f1f5f9;
  --panel:#ffffff;
  --border:#e5e7eb;
  --text:#0f172a;
  --muted:#64748b;
  --green:#16a34a;
  --amber:#f59e0b;
  --red:#dc2626;
  --blue:#2563eb;
}

body{
  margin:0;
  font-family:Inter,system-ui;
  background:var(--bg);
  padding:36px 20px;
  color:var(--text);
}

.wrapper{max-width:1200px;margin:auto;}
.card{
  background:var(--panel);
  border-radius:22px;
  padding:28px;
  box-shadow:0 30px 60px rgba(0,0,0,.12);
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:18px;
}

.controls{display:flex;gap:12px;align-items:center;}
select,input,textarea{
  padding:8px;
  border-radius:8px;
  border:1px solid var(--border);
}

button{
  background:var(--blue);
  color:#fff;
  border:none;
  border-radius:10px;
  padding:8px 14px;
  cursor:pointer;
}

button.secondary{
  background:#e5e7eb;
  color:#0f172a;
}

button.back{
  background:#64748b;
  margin-bottom:12px;
}

table{
  width:100%;
  border-collapse:collapse;
}

th,td{
  padding:14px;
  border-bottom:1px solid var(--border);
  text-align:center;
}

th{
  background:#f8fafc;
  font-size:12px;
  color:var(--muted);
}

.days.green{color:var(--green);font-weight:600}
.days.amber{color:var(--amber);font-weight:600}
.days.red{color:var(--red);font-weight:700}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:50;
}

.modal-content{
  background:#fff;
  border-radius:20px;
  padding:24px;
  width:620px;
  max-width:95%;
  max-height:90%;
  overflow-y:auto;
}

.image-thumb{
  width:70px;
  height:70px;
  object-fit:cover;
  border-radius:8px;
  margin:4px;
}

.status-box div{margin-top:4px;font-size:14px}
</style>
</head>

<body>
<div class="wrapper">
  <div class="card">
    <div class="header">
      <h2>üõ† Repairs <span id="openCounter" style="color:var(--red)">0 open</span></h2>
      <div class="controls">
        <label><input type="checkbox" id="showCompleted"> Show completed</label>
        <button onclick="openModal()">+ Add Repair</button>
      </div>
    </div>

    <button class="back" onclick="location.href='index.html'">‚Üê Back to Inventory</button>

    <table>
      <thead>
        <tr>
          <th>Customer</th>
          <th>Device</th>
          <th>Checked In</th>
          <th>Days Open</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="repairsBody"></tbody>
    </table>
  </div>
</div>

<!-- ADD / EDIT MODAL -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <h3 id="modalTitle">Add Repair</h3>
    <input id="customer" placeholder="Customer name">
    <select id="device">
      <option>PlayStation</option>
      <option>Xbox</option>
      <option>Nintendo</option>
      <option>iPad</option>
      <option>Laptop</option>
    </select>
    <input type="date" id="checkedIn">
    <textarea id="notes" placeholder="Notes"></textarea>

    <label>Photos (optional)</label>
    <input type="file" id="photoInput" multiple accept="image/*">
    <div id="photoPreview" style="display:flex;flex-wrap:wrap;"></div>
    <div id="photoStatus" class="status-box"></div>

    <button onclick="saveRepair()">Save</button>
    <button class="secondary" onclick="closeModal()">Cancel</button>
  </div>
</div>

<!-- DETAILS MODAL -->
<div class="modal" id="detailsModal">
  <div class="modal-content" id="detailsContent"></div>
</div>

<script>
const SUPABASE_URL = "https://thvbweemnzdvwyaxvwbz.supabase.co";
const SUPABASE_KEY = "sb_publishable_U6Nsj6HClebAVWOx7MLhng_3t2z6w1G";
const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let repairs=[], editingId=null, files=[];

const daysOpen = d => Math.floor((Date.now()-new Date(d))/86400000);
const dayClass = n => n<=2?"green":n<=5?"amber":"red";

async function load(){
  const {data}=await client.from("repairs").select("*").order("checked_in");
  repairs=data||[];
  render();
}

function render(){
  const body=document.getElementById("repairsBody");
  body.innerHTML="";
  const showCompleted=document.getElementById("showCompleted").checked;

  repairs.forEach(r=>{
    if(!showCompleted && r.completed) return;
    const days=daysOpen(r.checked_in);
    body.innerHTML+=`
      <tr>
        <td>${r.customer}</td>
        <td>${r.device}</td>
        <td>${r.checked_in}</td>
        <td class="days ${dayClass(days)}">${days}</td>
        <td>
          <button onclick="details(${r.id})">Details</button>
          ${r.completed?'':`<button onclick="complete(${r.id})">Complete</button>`}
          <button onclick="edit(${r.id})">Edit</button>
        </td>
      </tr>`;
  });

  document.getElementById("openCounter").innerText =
    repairs.filter(r=>!r.completed).length+" open";
}

function openModal(){
  editingId=null;
  customer.value="";
  device.value="PlayStation";
  checkedIn.value=new Date().toISOString().slice(0,10);
  notes.value="";
  photoPreview.innerHTML="";
  photoStatus.innerHTML="";
  files=[];
  editModal.style.display="flex";
}

function closeModal(){editModal.style.display="none"}

photoInput.onchange=e=>{
  files=[...e.target.files];
  photoPreview.innerHTML="";
  files.forEach(f=>{
    const img=document.createElement("img");
    img.src=URL.createObjectURL(f);
    img.className="image-thumb";
    photoPreview.appendChild(img);
  });
};

async function saveRepair(){
  const payload={
    customer:customer.value,
    device:device.value,
    checked_in:checkedIn.value,
    notes:notes.value,
    completed:false
  };

  let repairId=editingId;
  if(editingId){
    await client.from("repairs").update(payload).eq("id",editingId);
  }else{
    const {data}=await client.from("repairs").insert(payload).select();
    repairId=data[0].id;
  }

  for(const file of files){
    if(file.size>5*1024*1024){
      photoStatus.innerHTML+=`<div style="color:red">‚ùå ${file.name} too large</div>`;
      continue;
    }

    const safe=file.name.toLowerCase().replace(/[^a-z0-9._-]/g,"");
    const path=`repair_${repairId}/${Date.now()}_${safe}`;

    const {data, error}=await client.storage
      .from("repairs")
      .upload(path,file,{upsert:true,contentType:file.type});

    if(error){
      photoStatus.innerHTML+=`<div style="color:red">‚ùå ${file.name} failed</div>`;
      continue;
    }

    await client.from("repair_photos").insert({
      repair_id:repairId,
      file_path:data.path
    });

    photoStatus.innerHTML+=`<div style="color:green">‚úÖ ${file.name} uploaded</div>`;
  }

  setTimeout(()=>{closeModal();load();},500);
}

async function complete(id){
  await client.from("repairs").update({completed:true}).eq("id",id);
  load();
}

async function details(id){
  const r=repairs.find(x=>x.id===id);
  const {data:photos}=await client.from("repair_photos").select("*").eq("repair_id",id);

  let imgs="";
  photos?.forEach(p=>{
    const url=client.storage.from("repairs").getPublicUrl(p.file_path).data.publicUrl;
    imgs+=`<img src="${url}" class="image-thumb">`;
  });

  detailsContent.innerHTML=`
    <h3>${r.customer}</h3>
    <p><b>Device:</b> ${r.device}</p>
    <p><b>Notes:</b><br>${r.notes||"‚Äî"}</p>
    ${imgs?`<p><b>Photos:</b><br>${imgs}</p>`:""}
    <button onclick="detailsModal.style.display='none'">Close</button>
  `;
  detailsModal.style.display="flex";
}

function edit(id){
  const r=repairs.find(x=>x.id===id);
  editingId=id;
  customer.value=r.customer;
  device.value=r.device;
  checkedIn.value=r.checked_in;
  notes.value=r.notes||"";
  photoPreview.innerHTML="";
  photoStatus.innerHTML="";
  files=[];
  editModal.style.display="flex";
}

showCompleted.onchange=render;
load();
</script>
</body>
</html>
