<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Repairs</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#f1f5f9;
  --panel:#ffffff;
  --border:#e5e7eb;
  --text:#0f172a;
  --muted:#64748b;
  --green:#16a34a;
  --amber:#f59e0b;
  --red:#dc2626;
  --blue:#2563eb;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Inter,system-ui;
  background:var(--bg);
  padding:36px 20px;
  color:var(--text);
}

.wrapper{
  max-width:1200px;
  margin:auto;
}

.card{
  background:var(--panel);
  border-radius:22px;
  padding:28px;
  box-shadow:0 30px 60px rgba(0,0,0,.12);
}

/* HEADER */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}

.header h1{
  margin:0;
  font-size:22px;
}

.controls{
  display:flex;
  gap:12px;
  align-items:center;
}

select, input[type="date"]{
  padding:6px 10px;
  border-radius:8px;
  border:1px solid var(--border);
}

button{
  background:var(--blue);
  color:#fff;
  border:none;
  border-radius:10px;
  padding:8px 14px;
  cursor:pointer;
}

button.secondary{
  background:#e5e7eb;
  color:#0f172a;
}

button.back-btn{
  background:#64748b;
  margin-bottom:12px;
}

button.danger{
  background:var(--red);
}

/* TABLE */
table{
  width:100%;
  border-collapse:collapse;
}

th, td{
  padding:14px;
  border-bottom:1px solid var(--border);
  text-align:center;
}

th{
  font-size:12px;
  color:var(--muted);
  background:#f8fafc;
}

.days.green{color:var(--green);font-weight:600}
.days.amber{color:var(--amber);font-weight:600}
.days.red{color:var(--red);font-weight:700}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10;
}

.modal-content{
  background:#fff;
  border-radius:20px;
  padding:24px;
  width:500px;
  max-width:90%;
}

.modal h2{
  margin-top:0;
}

.modal textarea, .modal input, .modal select{
  width:100%;
  margin-bottom:10px;
  padding:8px;
  border-radius:8px;
  border:1px solid var(--border);
    height:120px; /* increase this value as needed */
  resize: vertical; /* allow user to resize vertically */
}

/* COMPLETE MODAL TABS */
.tabs{
  display:flex;
  gap:6px;
  margin-bottom:12px;
}

.tab-btn{
  padding:6px 12px;
  border:none;
  border-radius:8px;
  background:#e5e7eb;
  cursor:pointer;
}

.tab-btn.active{
  background:#2563eb;
  color:#fff;
}

.tab-content{
  display:none;
  max-height:250px;
  overflow-y:auto;
  margin-bottom:12px;
}

.tab-content label{
  display:block;
  margin-bottom:6px;
}
</style>
</head>

<body>
<div class="wrapper">
  <div class="card">

    <div class="header">
      <h1>üõ† Repairs <span id="openCounter" style="color:var(--red)">0 open</span></h1>
      <div class="controls">
        <select id="deviceFilter">
          <option value="">All Devices</option>
          <option>PlayStation</option>
          <option>Xbox</option>
          <option>Nintendo</option>
          <option>iPad</option>
          <option>Laptop</option>
        </select>

        <label>
          <input type="checkbox" id="showCompleted" />
          Show completed
        </label>

        <button onclick="openAddModal()">+ Add Repair</button>
      </div>
    </div>

    <button class="back-btn" onclick="window.location.href='index.html'">‚Üê Back to Inventory</button>

    <table>
      <thead>
        <tr>
          <th>Customer</th>
          <th>Device</th>
          <th>Checked In</th>
          <th>Days Open</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="repairsBody"></tbody>
    </table>

  </div>
</div>

<!-- ADD / EDIT MODAL -->
<div class="modal" id="addModal">
  <div class="modal-content">
    <h2 id="modalTitle">Add Repair</h2>

    <input id="custName" placeholder="Customer name" /><br>
    <select id="deviceType">
      <option>PlayStation</option>
      <option>Xbox</option>
      <option>Nintendo</option>
      <option>iPad</option>
      <option>Laptop</option>
    </select><br>
    <input type="date" id="checkedIn" /><br>
    <textarea id="notes" placeholder="Notes (optional)"></textarea><br>

    <button id="saveBtn" onclick="saveRepair()">Save</button>
    <button class="secondary" onclick="closeAddModal()">Cancel</button>
  </div>
</div>

<!-- DETAILS MODAL -->
<div class="modal" id="detailsModal">
  <div class="modal-content" id="detailsContent"></div>
</div>

<!-- COMPLETE MODAL -->
<div class="modal" id="completeModal">
  <div class="modal-content" id="completeContent"></div>
</div>

<script>
const SUPABASE_URL = "https://thvbweemnzdvwyaxvwbz.supabase.co";
const SUPABASE_KEY = "sb_publishable_U6Nsj6HClebAVWOx7MLhng_3t2z6w1G";
const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let repairs = [];
let editingId = null;
let completingId = null;

function daysOpen(date){
  return Math.floor((Date.now() - new Date(date)) / 86400000);
}

function daysClass(days){
  if(days <= 2) return "green";
  if(days <= 5) return "amber";
  return "red";
}

async function loadRepairs(){
  const { data, error } = await client.from("repairs").select("*").order("checked_in");
  if(error){ console.error(error); return; }
  repairs = data || [];
  render();
}

function render(){
  const body = document.getElementById("repairsBody");
  body.innerHTML = "";

  const filter = document.getElementById("deviceFilter").value;
  const showCompleted = document.getElementById("showCompleted").checked;

  repairs.forEach(r => {
    if(!showCompleted && r.completed) return;
    if(filter && r.device !== filter) return;

    const days = daysOpen(r.checked_in);
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${r.customer}</td>
      <td>${r.device}</td>
      <td>${r.checked_in}</td>
      <td class="days ${daysClass(days)}">${days}</td>
      <td>
        <button onclick="viewDetails(${r.id})">Details</button>
        ${r.completed ? '' : `<button onclick="completeRepair(${r.id})">Complete</button>`}
        <button onclick="editRepair(${r.id})">Edit</button>
        <button class="danger" onclick="deleteRepair(${r.id})">Delete</button>
      </td>
    `;
    body.appendChild(row);
  });

  updateOpenRepairCounter();
}

function updateOpenRepairCounter(){
  const openCount = repairs.filter(r => !r.completed).length;
  document.getElementById("openCounter").innerText = `${openCount} open`;
}

function openAddModal(){
  editingId = null;
  document.getElementById("modalTitle").innerText = "Add Repair";
  document.getElementById("custName").value = "";
  document.getElementById("deviceType").value = "PlayStation";
  document.getElementById("checkedIn").value = new Date().toISOString().slice(0,10);
  document.getElementById("notes").value = "";
  document.getElementById("addModal").style.display="flex";
}

function closeAddModal(){ document.getElementById("addModal").style.display="none"; }

async function saveRepair(){
  const customerInput = document.getElementById("custName");
  const deviceInput = document.getElementById("deviceType");
  const checkedInInput = document.getElementById("checkedIn");
  const notesInput = document.getElementById("notes");

  if(editingId){
    const { error } = await client.from("repairs").update({
      customer: customerInput.value,
      device: deviceInput.value,
      checked_in: checkedInInput.value,
      notes: notesInput.value
    }).eq("id", editingId);
    if(error){ alert(error.message); return; }
  } else {
    const { error } = await client.from("repairs").insert({
      customer: customerInput.value,
      device: deviceInput.value,
      checked_in: checkedInInput.value,
      notes: notesInput.value,
      completed:false
    });
    if(error){ alert(error.message); return; }
  }

  closeAddModal();
  await loadRepairs();
}

function viewDetails(id){
  const r = repairs.find(x => x.id===id);
  document.getElementById("detailsContent").innerHTML = `
    <h2>${r.customer}</h2>
    <p><strong>Device:</strong> ${r.device}</p>
    <p><strong>Checked in:</strong> ${r.checked_in}</p>
    <p><strong>Notes:</strong><br>${r.notes || "‚Äî"}</p>
    <p><strong>Completed:</strong> ${r.completed ? "Yes" : "No"}</p>
    <button onclick="closeDetails()">Close</button>
  `;
  document.getElementById("detailsModal").style.display="flex";
}

function closeDetails(){ document.getElementById("detailsModal").style.display="none"; }

function editRepair(id){
  const r = repairs.find(x => x.id===id);
  if(!r) return;

  editingId = id;
  document.getElementById("modalTitle").innerText = "Edit Repair";
  document.getElementById("custName").value = r.customer;
  document.getElementById("deviceType").value = r.device;
  document.getElementById("checkedIn").value = r.checked_in;
  document.getElementById("notes").value = r.notes;
  document.getElementById("addModal").style.display="flex";
}

async function completeRepair(id){
  const repair = repairs.find(r => r.id===id);
  if(!repair) return;
  completingId = id;

  const { data: products } = await client.from("products").select("*").order("name");

  const categories = ["PlayStation","Xbox","Nintendo","iPad","Laptop"];
  let html = `<h2>Complete Repair: ${repair.customer}</h2>`;
  html += `<p><strong>Device:</strong> ${repair.device}</p>`;
  html += `<p><strong>Notes:</strong> ${repair.notes || "‚Äî"}</p>`;

  // Tabs
  html += `<div class="tabs">`;
  categories.forEach((c,i)=>{
    html += `<button class="tab-btn ${i===0?'active':''}" data-tab="${c}">${c}</button>`;
  });
  html += `</div>`;

  categories.forEach((c,i)=>{
    html += `<div class="tab-content" data-tab="${c}" style="display:${i===0?'block':'none'}">`;
    products.filter(p=>p.brand===c).forEach(p=>{
      html += `<label>${p.name} (Stock: ${p.stock})
        <input type="number" min="0" max="${p.stock}" value="0" data-part-id="${p.id}" class="part-input" />
      </label>`;
    });
    html += `</div>`;
  });

  html += `<button onclick="confirmComplete()">Confirm</button>
           <button class="secondary" onclick="closeCompleteModal()">Cancel</button>`;

  document.getElementById("completeContent").innerHTML = html;
  document.getElementById("completeModal").style.display = "flex";
  setupTabs();
}

function closeCompleteModal(){ document.getElementById("completeModal").style.display="none"; }

function setupTabs(){
  const buttons = document.querySelectorAll(".tab-btn");
  const contents = document.querySelectorAll(".tab-content");
  buttons.forEach(btn => {
    btn.onclick = () => {
      buttons.forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.dataset.tab;
      contents.forEach(c=>c.style.display = c.dataset.tab === tab ? "block" : "none");
    }
  });
}

async function confirmComplete(){
  const inputs = document.querySelectorAll(".part-input");
  for(const inp of inputs){
    const id = parseInt(inp.dataset.partId,10);
    const used = parseInt(inp.value,10);
    if(used > 0){
      const { data } = await client.from("products").select("*").eq("id",id).single();
      const newStock = Math.max(0, data.stock - used);
      await client.from("products").update({stock:newStock}).eq("id",id);
    }
  }

  const { data, error } = await client.from("repairs").update({completed:true}).eq("id",completingId);
  console.log("Complete Update:", {data, error});
  if(error){ alert("Failed to mark complete. See console."); return; }

  const index = repairs.findIndex(r => r.id === completingId);
  if(index > -1){ repairs[index].completed = true; }

  closeCompleteModal();
  completingId = null;

  render();
  await loadRepairs();
}

// NEW DELETE FUNCTION
async function deleteRepair(id){
  if(!confirm("Are you sure you want to delete this repair?")) return;

  const { error } = await client.from("repairs").delete().eq("id", id);
  if(error){
    console.error("Delete failed:", error);
    alert("Failed to delete repair. Check console.");
    return;
  }

  repairs = repairs.filter(r => r.id !== id);
  render();
}

document.getElementById("deviceFilter").onchange = render;
document.getElementById("showCompleted").onchange = render;

loadRepairs();
</script>
</body>
</html>
