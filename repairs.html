<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Repairs</title>

<style>
:root{
  --bg:#f1f5f9;
  --panel:#ffffff;
  --border:#e5e7eb;
  --text:#0f172a;
  --muted:#64748b;
  --red:#dc2626;
  --blue:#2563eb;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Inter,system-ui;
  background:
    radial-gradient(1200px 400px at top center,#e0e7ff 0%,transparent 60%),
    var(--bg);
  background-attachment:fixed;
  padding:36px 20px;
  color:var(--text);
}

.wrapper{
  max-width:950px;
  margin:auto;
}

.panel{
  background:var(--panel);
  border-radius:22px;
  box-shadow:0 30px 60px rgba(0,0,0,.12);
  padding:28px 26px;
}

/* Header */
.panel-header{
  text-align:center;
  margin-bottom:22px;
}
.panel-header h1{
  margin:0;
  font-size:20px;
  font-weight:600;
}
.panel-header p{
  margin:6px 0 0;
  font-size:13px;
  color:var(--muted);
}
#repairCount{
  margin-top:8px;
  font-size:13px;
  font-weight:600;
  color:var(--blue);
}

/* Top right */
.header-right{
  display:flex;
  justify-content:flex-end;
  margin-bottom:20px;
}

/* Buttons */
.action-btn{
  background:var(--blue);
  color:#fff;
  border:none;
  border-radius:8px;
  padding:6px 14px;
  cursor:pointer;
  font-size:13px;
}
.secondary{
  background:#e5e7eb;
  color:#0f172a;
}
.danger{
  background:var(--red);
}

/* Form */
form{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-bottom:22px;
}

input{
  padding:6px 8px;
  border-radius:8px;
  border:1px solid var(--border);
  min-width:160px;
  font-size:13px;
}

/* Table */
table{
  width:100%;
  border-collapse:collapse;
  text-align:center;
}

th,td{
  padding:14px 18px;
  border-bottom:1px solid var(--border);
}

th{
  background:#f8fafc;
  font-size:12px;
  color:var(--muted);
}

tbody tr:hover{
  background:#f8fafc;
}

/* Inline edit */
.edit-input{
  width:100%;
  padding:6px 8px;
  border-radius:8px;
  border:1px solid var(--border);
  font-size:13px;
}
</style>
</head>

<body>
<div class="wrapper">
<div class="panel">

  <div class="panel-header">
    <h1>Daily Repairs</h1>
    <p>Active repair tracking (delete = completed)</p>
    <div id="repairCount">Active Repairs: 0</div>
  </div>

  <div class="header-right">
    <button class="action-btn secondary" onclick="location.href='index.html'">
      â¬… Back to Inventory
    </button>
  </div>

  <!-- Add Form -->
  <form id="repairForm">
    <input id="username" placeholder="Username" required>
    <input id="item" placeholder="Item" required>
    <input id="notes" placeholder="Status notes" required>
    <button class="action-btn">Add</button>
  </form>

  <!-- Table -->
  <table>
    <thead>
      <tr>
        <th>Username</th>
        <th>Item</th>
        <th>Status Notes</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://thvbweemnzdvwyaxvwbz.supabase.co";
const SUPABASE_KEY = "sb_publishable_U6Nsj6HClebAVWOx7MLhng_3t2z6w1G";
const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const tbody = document.getElementById('rows');
const form = document.getElementById('repairForm');

/* Load repairs */
async function load(){
  const { data, error } = await client
    .from('repairs')
    .select('id, username, item, notes')
    .order('created_at',{ascending:false});

  if(error){
    alert(error.message);
    return;
  }
  render(data);
  updateRepairCount();
}

/* Render table */
function render(data){
  tbody.innerHTML='';
  data.forEach(r=>{
    tbody.innerHTML += `
      <tr>
        <td>${r.username}</td>
        <td>${r.item}</td>
        <td>${r.notes}</td>
        <td>
          <button class="action-btn" onclick="edit(${r.id})">Edit</button>
          <button class="action-btn danger" onclick="del(${r.id})">Delete</button>
        </td>
      </tr>`;
  });
}

/* Update counter */
async function updateRepairCount(){
  const { count } = await client
    .from('repairs')
    .select('*',{count:'exact',head:true});

  document.getElementById('repairCount').innerText =
    `Active Repairs: ${count ?? 0}`;
}

/* Inline edit */
async function edit(id){
  const { data } = await client
    .from('repairs')
    .select('*')
    .eq('id',id)
    .single();

  const row = [...tbody.children]
    .find(r => r.innerHTML.includes(`edit(${id})`));

  row.innerHTML = `
    <td><input class="edit-input" value="${data.username}"></td>
    <td><input class="edit-input" value="${data.item}"></td>
    <td><input class="edit-input" value="${data.notes}"></td>
    <td>
      <button class="action-btn" onclick="save(${id},this)">Save</button>
    </td>`;
}

/* Save edit */
async function save(id,btn){
  const row = btn.closest('tr');
  const inputs = row.querySelectorAll('input');

  await client.from('repairs').update({
    username: inputs[0].value,
    item: inputs[1].value,
    notes: inputs[2].value
  }).eq('id',id);

  load();
}

/* Delete = completed */
async function del(id){
  if(!confirm('Mark this repair as completed and remove it?')) return;
  await client.from('repairs').delete().eq('id',id);
  load();
}

/* Add */
form.onsubmit = async e =>{
  e.preventDefault();

  await client.from('repairs').insert({
    username: username.value,
    item: item.value,
    notes: notes.value
  });

  form.reset();
  load();
};

load();
</script>
</body>
</html>
