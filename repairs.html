<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Repair Photo Upload Test</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<h1>Upload Repair Photos</h1>

<input type="file" id="photoInput" multiple accept="image/*" />
<div id="preview" style="display:flex; gap:8px; margin:8px 0;"></div>
<div id="status"></div>
<button id="uploadBtn">Upload Photos</button>

<script>
const SUPABASE_URL = "https://thvbweemnzdvwyaxvwbz.supabase.co";
const SUPABASE_KEY = "sb_publishable_U6Nsj6HClebAVWOx7MLhng_3t2z6w1G";
const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let files = [];

const input = document.getElementById("photoInput");
const preview = document.getElementById("preview");
const status = document.getElementById("status");

input.addEventListener("change", e => {
  files = Array.from(e.target.files);
  preview.innerHTML = "";
  files.forEach(f=>{
    const img = document.createElement("img");
    img.src = URL.createObjectURL(f);
    img.style.width="80px";
    img.style.height="80px";
    img.style.objectFit="cover";
    preview.appendChild(img);
  });
});

document.getElementById("uploadBtn").addEventListener("click", async ()=>{
  if(!files.length){ alert("No files selected"); return; }
  status.innerHTML = "";

  for(const file of files){
    const safeName = file.name.replace(/\s+/g,'_');
    const path = `test_uploads/${Date.now()}_${safeName}`;  // folder in bucket
    try{
      const { data, error } = await client.storage.from('repairs').upload(path, file, {upsert:true});
      if(error){
        status.innerHTML += `<div style="color:red">❌ ${file.name} failed: ${error.message}</div>`;
        continue;
      }
      // get public URL
      const publicUrl = client.storage.from('repairs').getPublicUrl(data.path).data.publicUrl;
      status.innerHTML += `<div style="color:green">✅ ${file.name} uploaded <a href="${publicUrl}" target="_blank">View</a></div>`;
    }catch(e){
      console.error(e);
      status.innerHTML += `<div style="color:red">❌ ${file.name} error</div>`;
    }
  }
});
</script>
</body>
</html>
