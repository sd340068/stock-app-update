<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Repairs</title>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const SUPABASE_URL = "https://thxyrmscrwstcyhifijv.supabase.co";
const SUPABASE_KEY = "sb_publishable_U1nguijT4zbVmfkZ-RP29Q_X2Tr-WoE";

window.supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
</script>

<style>
:root{
  --bg:#f1f5f9;
  --panel:#ffffff;
  --border:#e5e7eb;
  --text:#0f172a;
  --muted:#64748b;
  --green:#16a34a;
  --amber:#f59e0b;
  --red:#dc2626;
  --blue:#2563eb;
}

body{margin:0;font-family:Inter,system-ui;background:var(--bg);padding:36px 20px;color:var(--text);}
.wrapper{max-width:1200px;margin:auto;}
.card{background:var(--panel);border-radius:22px;padding:28px;box-shadow:0 30px 60px rgba(0,0,0,.12);}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;}
.controls{display:flex;gap:12px;align-items:center;}
select,input,textarea{padding:8px;border-radius:8px;border:1px solid var(--border);}
button{background:var(--blue);color:#fff;border:none;border-radius:10px;padding:8px 14px;cursor:pointer;}
button.secondary{background:#e5e7eb;color:#0f172a;}
button.danger{background:var(--red);}
table{width:100%;border-collapse:collapse;}
th,td{padding:14px;border-bottom:1px solid var(--border);text-align:center;}
th{background:#f8fafc;font-size:12px;color:var(--muted);}
.actions{display:flex;gap:6px;justify-content:center;}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:50;}
.modal-content{background:#fff;border-radius:20px;padding:24px;width:520px;max-width:95%;}
.modal-content h2{margin-top:0;}
.modal-content label{display:block;margin-top:10px;}
.modal-content input,.modal-content textarea,.modal-content select{width:100%;padding:6px;border-radius:8px;border:1px solid var(--border);margin-top:4px;}
.modal-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:15px;}
</style>
</head>

<body>
<div class="wrapper">
  <div class="card">
    <div class="header">
      <h2>ðŸ›  Repairs <span id="openCounter" style="color:var(--red)">0 open</span></h2>
      <div class="controls">
        <label><input type="checkbox" id="showCompleted"> Show completed</label>
        <select id="filterDevice">
          <option value="">All Devices</option>
          <option>PlayStation</option>
          <option>Xbox</option>
          <option>Nintendo</option>
          <option>iPad</option>
          <option>Laptop</option>
        </select>
        <button type="button" onclick="openModal()">+ Add Repair</button>
        <button type="button" class="secondary" onclick="window.location.href='index.html'">Back to Inventory</button>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Customer</th>
          <th>Device</th>
          <th>Checked In</th>
          <th>Days Open</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="repairsBody"></tbody>
    </table>
  </div>
</div>

<div class="modal" id="editModal">
  <div class="modal-content">
    <h2 id="modalTitle">Add Repair</h2>
    <input type="hidden" id="repairId">
    <label>Customer Name</label>
    <input id="customer">
    <label>Device</label>
    <select id="device">
      <option>PlayStation</option>
      <option>Xbox</option>
      <option>Nintendo</option>
      <option>iPad</option>
      <option>Laptop</option>
    </select>
    <label>Notes</label>
    <textarea id="notes"></textarea>
    <div class="modal-actions">
      <button type="button" class="secondary" onclick="closeModal()">Cancel</button>
      <button type="button" id="saveBtn">Save</button>
    </div>
  </div>
</div>

<script type="module">
const client = window.supabaseClient;
let repairs = [];
let editingId = null;

function daysOpen(date){
  return date ? Math.max(0, Math.floor((Date.now() - new Date(date)) / 86400000)) : 0;
}

async function loadRepairs(){
  const { data, error } = await client.from('repairs').select('*');
  if(error){ console.error(error); alert("Failed to fetch repairs"); return; }
  repairs = data || [];
  repairs.sort((a,b) => new Date(a.checked_in || 0) - new Date(b.checked_in || 0));
  renderRepairs();
}

function renderRepairs(){
  const tbody = document.getElementById("repairsBody");
  const showCompleted = document.getElementById("showCompleted").checked;
  const filterDevice = document.getElementById("filterDevice").value;
  tbody.innerHTML = "";

  if(repairs.length === 0){
    tbody.innerHTML = `<tr><td colspan="5">No repairs found</td></tr>`;
    return;
  }

  repairs.forEach(r => {
    if(!showCompleted && r.completed) return;
    if(filterDevice && r.device !== filterDevice) return;
    const days = daysOpen(r.checked_in);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.customer}</td>
      <td>${r.device}</td>
      <td>${r.checked_in ? new Date(r.checked_in).toLocaleDateString() : "â€”"}</td>
      <td>${days}</td>
      <td class="actions">
        <button onclick="editRepair(${r.id})">Edit</button>
        ${r.completed ? "" : `<button onclick="completeRepair(${r.id})">Complete</button>`}
        <button class="danger" onclick="deleteRepair(${r.id})">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("openCounter").innerText =
    repairs.filter(r => !r.completed).length + " open";
}

function openModal(){
  editingId = null;
  document.getElementById("modalTitle").innerText = "Add Repair";
  document.getElementById("repairId").value = "";
  document.getElementById("customer").value = "";
  document.getElementById("device").value = "PlayStation";
  document.getElementById("notes").value = "";
  document.getElementById("editModal").style.display = "flex";
  document.getElementById("customer").focus();
}
function closeModal(){ document.getElementById("editModal").style.display = "none"; }
document.getElementById("editModal").addEventListener("click", e => { if(e.target.id==="editModal") closeModal(); });
document.addEventListener("keydown", e => { if(e.key==="Escape") closeModal(); });

document.getElementById("saveBtn").onclick = async () => {
  const customer = document.getElementById("customer").value.trim();
  if(!customer){ alert("Customer required"); return; }
  const payload = {
    customer,
    device: document.getElementById("device").value,
    notes: document.getElementById("notes").value,
    completed: false,
    checked_in: new Date().toISOString()
  };
  if(editingId){
    const { error } = await client.from('repairs').update(payload).eq('id', editingId);
    if(error){ console.error(error); alert("Update failed"); return; }
  } else {
    const { error } = await client.from('repairs').insert(payload);
    if(error){ console.error(error); alert("Insert failed"); return; }
  }
  closeModal();
  loadRepairs();
};

window.editRepair = async (id) => {
  const { data, error } = await client.from('repairs').select('*').eq('id', id).single();
  if(error){ console.error(error); alert("Load failed"); return; }
  editingId = data.id;
  document.getElementById("modalTitle").innerText = "Edit Repair";
  document.getElementById("customer").value = data.customer;
  document.getElementById("device").value = data.device;
  document.getElementById("notes").value = data.notes || "";
  document.getElementById("editModal").style.display = "flex";
};

window.completeRepair = async (id) => {
  if(!confirm("Mark complete?")) return;
  const { error } = await client.from('repairs').update({ completed:true }).eq('id', id);
  if(error){ console.error(error); alert("Complete failed"); return; }
  loadRepairs();
};

window.deleteRepair = async (id) => {
  if(!confirm("Delete permanently?")) return;
  const { error } = await client.from('repairs').delete().eq('id', id);
  if(error){ console.error(error); alert("Delete failed"); return; }
  loadRepairs();
};

document.getElementById("showCompleted").onchange = renderRepairs;
document.getElementById("filterDevice").onchange = renderRepairs;

loadRepairs();
</script>

</body>
</html>
